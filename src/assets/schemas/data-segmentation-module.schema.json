{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://schemas.complylight.com/fhir/r5/data-segmentation-module.schema.json",
    "$comment": "IMPORTANT: When creating bindings, ensure that 'category' and 'purpose' values match existing codes in the categories and purposes arrays. Policy IDs in bindings must reference policies defined in the root 'policies' array. Parent category references must point to categories that appear earlier in the categories array.",
    "title": "Data Segmentation Module",
    "description": "Schema for defining data segmentation modules with categories, purposes, hierarchical concept trees, and sensitivity rule bindings",
    "type": "object",
    "required": [
        "id",
        "name",
        "version",
        "description",
        "enabled",
        "categories",
        "purposes"
    ],
    "properties": {
        "id": {
            "type": "string",
            "description": "Unique identifier for the module",
            "examples": ["default-example", "my-custom-module", "42cfr-part2"]
        },
        "name": {
            "type": "string",
            "description": "Human-readable name of the module",
            "examples": ["Default Example Module", "My Custom Module", "42 CFR Part 2 Module"]
        },
        "version": {
            "type": "string",
            "description": "Version identifier for the module",
            "examples": ["1.0.0", "2.1.3", "1.0"]
        },
        "description": {
            "type": "string",
            "description": "Description of the module's purpose and scope",
            "examples": ["Reference implementation module containing default information categories", "Custom module for specific regulatory requirements"]
        },
        "enabled": {
            "type": "boolean",
            "description": "Whether the module is enabled by default",
            "default": true
        },
        "categories": {
            "type": "array",
            "description": "Array of information category definitions. These categories can be referenced by their 'code' field in rule bindings.",
            "minItems": 0,
            "items": {
                "$ref": "#/definitions/categoryOrPurpose"
            }
        },
        "purposes": {
            "type": "array",
            "description": "Array of purpose of use definitions. These purposes can be referenced by their 'code' field in rule bindings.",
            "minItems": 0,
            "items": {
                "$ref": "#/definitions/categoryOrPurpose"
            }
        },
        "policies": {
            "type": "array",
            "description": "Array of policy definitions that reference regulatory controls, rules, or other policies. Policies defined here can be referenced by their 'id' field in rule bindings.",
            "minItems": 0,
            "items": {
                "$ref": "#/definitions/policy"
            }
        },
        "rules": {
            "type": "object",
            "description": "Optional rules object containing sensitivity rule bindings",
            "examples": [{
                "bindings": [{
                    "id": "example-binding",
                    "category": "SUD",
                    "purpose": "RESEARCH",
                    "basis": {
                        "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
                        "code": "42CFRPart2",
                        "display": "42 CFR Part 2"
                    },
                    "labels": [],
                    "codeSets": [],
                    "policies": []
                }]
            }],
            "properties": {
                "bindings": {
                    "type": "array",
                    "description": "Array of rule bindings that link sensitivity rules to categories and purposes",
                    "minItems": 0,
                    "items": {
                        "$ref": "#/definitions/binding"
                    }
                }
            }
        }
    },
    "definitions": {
        "categoryOrPurpose": {
            "type": "object",
            "required": [
                "code",
                "name"
            ],
            "properties": {
                "code": {
                    "type": "string",
                    "description": "The code value (e.g., 'SUD', 'MENCAT'). This code is used to reference this category or purpose in rule bindings.",
                    "examples": ["SUD", "MENCAT", "DEMO", "HIPAAConsentCD", "RESEARCH"]
                },
                "system": {
                    "type": "string",
                    "description": "The code system URI",
                    "format": "uri",
                    "examples": [
                        "http://terminology.hl7.org/CodeSystem/v3-ActCode",
                        "http://snomed.info/sct",
                        "http://www.nlm.nih.gov/research/umls/rxnorm"
                    ]
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable name of the category or purpose",
                    "examples": ["Substance Use", "Mental Health", "Treatment", "Research"]
                },
                "description": {
                    "type": "string",
                    "description": "Detailed description of the category or purpose",
                    "examples": ["Records possibly pertaining to commonly abused substances", "For the purposes of providing or supporting care"]
                },
                "parent": {
                    "type": "string",
                    "description": "Optional parent category code for hierarchical concept trees. Supports unlimited depth. Must reference the 'code' field of another category in the same categories array that appears earlier in the array. Leave undefined for root-level categories.",
                    "examples": ["SUD", "MENCAT"]
                }
            }
        },
        "coding": {
            "type": "object",
            "required": [
                "system",
                "code"
            ],
            "properties": {
                "system": {
                    "type": "string",
                    "description": "The code system URI",
                    "format": "uri",
                    "examples": [
                        "http://terminology.hl7.org/CodeSystem/v3-ActCode",
                        "http://snomed.info/sct"
                    ]
                },
                "code": {
                    "type": "string",
                    "description": "The code value within the system",
                    "examples": ["42CFRPart2", "SUD", "123456789"]
                },
                "display": {
                    "type": "string",
                    "description": "Human-readable representation of the code",
                    "examples": ["42 CFR Part 2", "Substance Use", "Example Display Name"]
                }
            }
        },
        "codeSetCoding": {
            "type": "object",
            "required": [
                "system",
                "code",
                "confidence"
            ],
            "properties": {
                "system": {
                    "type": "string",
                    "description": "The code system URI",
                    "format": "uri",
                    "examples": [
                        "http://www.nlm.nih.gov/research/umls/rxnorm",
                        "http://snomed.info/sct"
                    ]
                },
                "code": {
                    "type": "string",
                    "description": "The code value within the system",
                    "examples": ["480", "123456789", "987654321"]
                },
                "confidence": {
                    "type": "number",
                    "description": "Confidence score for this coding match, typically between 0.0 and 1.0",
                    "examples": [0, 0.5, 1.0]
                }
            }
        },
        "codeSet": {
            "type": "object",
            "required": [
                "groupID",
                "codes"
            ],
            "properties": {
                "groupID": {
                    "type": "string",
                    "description": "Identifier for this group of codes",
                    "examples": ["alfentanil", "test1-group", "medication-group"]
                },
                "codes": {
                    "type": "array",
                    "description": "Array of codings with confidence scores",
                    "minItems": 0,
                    "items": {
                        "$ref": "#/definitions/codeSetCoding"
                    }
                }
            }
        },
        "binding": {
            "type": "object",
            "required": [
                "id",
                "basis",
                "labels",
                "codeSets",
                "category",
                "purpose",
                "policies"
            ],
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier for the binding",
                    "examples": ["leap-rule-sud", "test-binding-test1", "example-binding"]
                },
                "basis": {
                    "$ref": "#/definitions/coding",
                    "description": "The basis coding for this binding, indicating the regulatory or policy basis"
                },
                "labels": {
                    "type": "array",
                    "description": "Array of label codings that apply to this binding",
                    "minItems": 0,
                    "items": {
                        "$ref": "#/definitions/coding"
                    }
                },
                "codeSets": {
                    "type": "array",
                    "description": "Array of code sets that define the codes and confidence scores for this binding",
                    "minItems": 0,
                    "items": {
                        "$ref": "#/definitions/codeSet"
                    }
                },
                "category": {
                    "type": "string",
                    "description": "Required reference to a category code from the categories array. Must match the 'code' field of an item in the categories array.",
                    "examples": ["SUD", "MENCAT", "TEST1"]
                },
                "purpose": {
                    "type": "string",
                    "description": "Required reference to a purpose code from the purposes array. Must match the 'code' field of an item in the purposes array.",
                    "examples": ["HIPAAConsentCD", "RESEARCH"]
                },
                "policies": {
                    "type": "array",
                    "description": "Required array of policy IDs that reference policies from the root policies array. Each string must match the 'id' field of a policy in the policies array.",
                    "minItems": 0,
                    "items": {
                        "type": "string"
                    },
                    "examples": [["policy-42cfr-part2"], ["policy-hipaa", "policy-state-law"]]
                }
            }
        },
        "policy": {
            "type": "object",
            "required": [
                "id",
                "name",
                "control_authority",
                "control_id"
            ],
            "description": "Policy definition referencing regulatory controls, rules, or other policies. Policies defined here can be referenced by their 'id' in rule bindings.",
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier for the policy. This ID can be referenced in rule bindings via the 'policies' array.",
                    "examples": ["policy-42cfr-part2", "policy-hipaa", "policy-state-law"]
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable name of the policy",
                    "examples": ["42 CFR Part 2", "HIPAA Privacy Rule", "State Privacy Law"]
                },
                "control_authority": {
                    "type": "string",
                    "description": "The authority that issued the control (e.g., 'CFR', 'HIPAA', 'State Law')",
                    "examples": ["CFR", "HIPAA", "State Law", "FDA"]
                },
                "control_id": {
                    "type": "string",
                    "description": "The identifier of the control (e.g., '42 CFR Part 2 §2.11', 'HIPAA §164.512')",
                    "examples": ["42 CFR Part 2 §2.11", "HIPAA §164.512", "State Law §123.45"]
                }
            }
        }
    },
    "examples": [
        {
            "id": "example-module",
            "name": "Example Module",
            "version": "1.0.0",
            "description": "A minimal example module",
            "enabled": true,
            "categories": [
                {
                    "code": "EXAMPLE",
                    "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
                    "name": "Example Category",
                    "description": "An example information category"
                }
            ],
            "purposes": [
                {
                    "code": "TREATMENT",
                    "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
                    "name": "Treatment",
                    "description": "For the purposes of providing or supporting care"
                }
            ]
        }
    ]
}

